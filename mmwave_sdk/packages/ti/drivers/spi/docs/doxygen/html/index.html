<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SPI Driver</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table width=100%>
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border=0 src="../../tilogo.gif"></a></td>
  <td bgcolor="red"><img src="../../titagline.gif"></td>
</tr>
</table>
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SPI Driver </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The SPI header file should be included in an application as follows: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ti/drivers/SPI.h&gt;</span></div></div><!-- fragment --><h1>Operation</h1>
<p>The SPI driver in TI-RTOS is designed to serve a means to move data between SPI peripherals. This driver does not interpret any of the data sent to or received from this peripheral.</p>
<p>The APIs in this driver serve as an interface to a typical TI-RTOS application. The specific peripheral implementations are responsible to create all the SYS/BIOS specific primitives to allow for thread-safe operation.</p>
<p>The SPI driver operates on some key definitions and assumptions:</p><ul>
<li>The driver operates transparent from the chip select. Some SPI controllers feature a hardware chip select to assert SPI slave peripherals. See the specific peripheral implementations on chip select requirements.</li>
<li>The SPI protocol does not account for a built-in handshaking mechanism and neither does this SPI driver. Therefore, when operating in <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6abc98c1546fe12d3fceb1f86cf670faa9">SPI_SLAVE</a> mode, the application must provide such a mechanism to ensure that the SPI slave is ready for the SPI master. The SPI slave must call <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga989e17f96b54fcc3dc2cac5f8ac6bdb2" title="Function to perform SPI transactions. ">SPI_transfer()</a> <em>before</em> the SPI master starts transmitting. Some example application mechanisms could include:<ul>
<li>Timed delays on the SPI master to guarantee the SPI slave is be ready for a SPI transaction.</li>
<li>A form of GPIO flow control from the slave to the SPI master to notify the master when ready.</li>
</ul>
</li>
<li>When SPI operates in <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6a84379dc90398ca075038c8d5ee465f6a">SPI_MASTER</a>, the partition of TX/RX RAM should be provided by application by providing proper values in <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gab779810da13a5968161b169292354627" title="SPI Parameters. ">SPI_Params</a>, such as number of slaves and slave profiles. The maximum number of supported slaves is platform specfic, please refer to TRM for the information. The maximum number of slaves supported in the driver is <a class="el" href="_s_p_i_8h.html#acf5783edea33f7594c6e3738670e9909" title="Max number of slaves supported when MibSPI is configured as master. ">MIBSPI_SLAVE_MAX</a>.</li>
</ul>
<p>The platform specific SPI file present in the ti/drivers/spi/platform directory. This file is built as a part of the SPI Library for the specific platform.</p>
<h2>Opening the driver</h2>
<p>Code examples for opening SPI driver in master and slave mode</p>
<p>Open SPI driver as <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6a84379dc90398ca075038c8d5ee465f6a">SPI_MASTER</a></p>
<div class="fragment"><div class="line"><a class="code" href="struct_s_p_i___config__t.html">SPI_Handle</a>      handle;</div><div class="line"><a class="code" href="struct_s_p_i___params__t.html">SPI_Params</a>      params;</div><div class="line"><a class="code" href="struct_s_p_i___transaction__t.html">SPI_Transaction</a> spiTransaction;</div><div class="line"></div><div class="line"><a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9c3dd1748332fd6e31c79a6538a71642">SPI_Params_init</a>(&amp;params);</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#ab2d6a6138c86042fb3c3fa3b5412a1bb">mode</a>  = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6a84379dc90398ca075038c8d5ee465f6a">SPI_MASTER</a>;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#adfa8c94d1f32284900693a2dbdbdbffa">bitRate</a> = bitRate;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#a11ccc7a860e9e17f3f4dc33c48fb74a5">numSlaves</a> = 1;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[0].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab7de3657d99ad6924922f43f68fbbc65">chipSelect</a> = 0;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[0].<a class="code" href="struct_s_p_i___slave_profile__t.html#a5f5106acc380b3535a46d56fe6ab8243">ramBufLen</a> = <a class="code" href="_s_p_i_8h.html#a11a937fd24c9ec2ed0961474f106f215">MIBSPI_RAM_MAX_ELEM</a>/2;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[0].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab4d2101a6ee5fb5e5c4aec9ecbb9811b">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#ae53cb8c0dbc3ee9ab8fa297d786e5cc3">txDmaChanNum</a> =1U; </div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[0].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab4d2101a6ee5fb5e5c4aec9ecbb9811b">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#a5ac4be5109690db3a5dd51f6a2b770ca">rxDmaChanNum</a> =0U;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[1].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab7de3657d99ad6924922f43f68fbbc65">chipSelect</a> = 1;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[1].<a class="code" href="struct_s_p_i___slave_profile__t.html#a5f5106acc380b3535a46d56fe6ab8243">ramBufLen</a> = <a class="code" href="_s_p_i_8h.html#a11a937fd24c9ec2ed0961474f106f215">MIBSPI_RAM_MAX_ELEM</a>/2;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[1].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab4d2101a6ee5fb5e5c4aec9ecbb9811b">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#ae53cb8c0dbc3ee9ab8fa297d786e5cc3">txDmaChanNum</a> =3U; </div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a4a0cc6ad2bb3e8bb6c975de5a20dcc6b">masterParams</a>.<a class="code" href="struct_s_p_i___master_mode_params__t.html#ab79b9c4416dd2937da54f461021c9134">slaveProf</a>[1].<a class="code" href="struct_s_p_i___slave_profile__t.html#ab4d2101a6ee5fb5e5c4aec9ecbb9811b">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#a5ac4be5109690db3a5dd51f6a2b770ca">rxDmaChanNum</a> =2U;</div><div class="line"></div><div class="line">handle = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga1637a236d20a3373d1120620704fa686">SPI_open</a>(someSPI_configIndexValue, &amp;params);</div><div class="line"><span class="keywordflow">if</span> (!handle) {</div><div class="line">    System_printf(<span class="stringliteral">&quot;SPI did not open&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>Open SPI driver as <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6abc98c1546fe12d3fceb1f86cf670faa9">SPI_SLAVE</a></p>
<div class="fragment"><div class="line"><a class="code" href="struct_s_p_i___config__t.html">SPI_Handle</a>      handle;</div><div class="line"><a class="code" href="struct_s_p_i___params__t.html">SPI_Params</a>      params;</div><div class="line"><a class="code" href="struct_s_p_i___transaction__t.html">SPI_Transaction</a> spiTransaction;</div><div class="line"></div><div class="line"><a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9c3dd1748332fd6e31c79a6538a71642">SPI_Params_init</a>(&amp;params);</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#ab2d6a6138c86042fb3c3fa3b5412a1bb">mode</a> = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6abc98c1546fe12d3fceb1f86cf670faa9">SPI_SLAVE</a>;</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#a278ab7a1e3a7a2fb116e487cb39f886d">frameFormat</a> = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga7ec7eff663b70ac287a32c42ee8ac140a0396d8c01166ff94e94e0c200261eba3">SPI_POL0_PHA0</a>;</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#ac908ecbe78d96811b416bf162019bd44">pinMode</a> = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga18d999b769031e80870d65fa59e95ac4a3cf9c5572d87269a203204f8ee4a5f12">SPI_PINMODE_4PIN_CS</a>;</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#a97921a394d0ee147b0b1645d997b7eda">shiftFormat</a> = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga6b00d6416761758bf291e3560a1e91f3a8912f763c0e7854e08dfbe61b7a57cc6">SPI_MSB_FIRST</a>;</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#a29d345f559d174348c6bad8c510feb11">dmaEnable</a> = 1;</div><div class="line">params.<a class="code" href="struct_s_p_i___params__t.html#a55c74d9f451981702e0a034bdb25b110">dmaHandle</a> = gDmaHandle;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a485665e65e538d53209ed8833764d541">slaveParams</a>.<a class="code" href="struct_s_p_i___slave_mode_params__t.html#a6576e3c1c3c1ff691fac6674d04dbfc3">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#ae53cb8c0dbc3ee9ab8fa297d786e5cc3">txDmaChanNum</a> =1U;</div><div class="line">params.u.<a class="code" href="struct_s_p_i___params__t.html#a485665e65e538d53209ed8833764d541">slaveParams</a>.<a class="code" href="struct_s_p_i___slave_mode_params__t.html#a6576e3c1c3c1ff691fac6674d04dbfc3">dmaCfg</a>.<a class="code" href="struct_s_p_i___d_m_a_chan_cfg__t.html#a5ac4be5109690db3a5dd51f6a2b770ca">rxDmaChanNum</a> =0U;</div><div class="line">handle = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga1637a236d20a3373d1120620704fa686">SPI_open</a>(someSPI_configIndexValue, &amp;params);</div><div class="line"><span class="keywordflow">if</span> (!handle) {</div><div class="line">    System_printf(<span class="stringliteral">&quot;SPI did not open&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><h2>Transferring data</h2>
<p>Data transmitted and received by the SPI peripheral is performed using <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga989e17f96b54fcc3dc2cac5f8ac6bdb2" title="Function to perform SPI transactions. ">SPI_transfer()</a>. <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga989e17f96b54fcc3dc2cac5f8ac6bdb2" title="Function to perform SPI transactions. ">SPI_transfer()</a> accepts a pointer to a SPI_Transaction structure that dictates what quantity of data is sent and received.</p>
<div class="fragment"><div class="line"><a class="code" href="struct_s_p_i___transaction__t.html">SPI_Transaction</a> spiTransaction;</div><div class="line"></div><div class="line">spiTransaction.<a class="code" href="struct_s_p_i___transaction__t.html#a466816d104c86950f1bb994e454e63c3">count</a> = someIntegerValue;</div><div class="line">spiTransaction.<a class="code" href="struct_s_p_i___transaction__t.html#af88c287b607b365b201259e8cb3baed3">txBuf</a> = transmitBufferPointer;</div><div class="line">spiTransaction.<a class="code" href="struct_s_p_i___transaction__t.html#a503a0813a56472e542b6a72c8155520b">rxBuf</a> = receiveBufferPointer;</div><div class="line">spiTransaction.<a class="code" href="struct_s_p_i___transaction__t.html#aa659a12819f6fba68785f6bbbcc6f875">slaveIndex</a> = index1;  <span class="comment">// For master mode only</span></div><div class="line"></div><div class="line">ret = <a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga989e17f96b54fcc3dc2cac5f8ac6bdb2">SPI_transfer</a>(handle, &amp;spiTransaction);</div><div class="line"><span class="keywordflow">if</span> (!ret) {</div><div class="line">    System_printf(<span class="stringliteral">&quot;Unsuccessful SPI transfer&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>When SPI driver is configured in <a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga2af20632fe200a031eebe1d414ef15e6a84379dc90398ca075038c8d5ee465f6a">SPI_MASTER</a> model, slave index need to be provided to indicate which slave the transfer is for.</p>
<h2>Canceling a transaction</h2>
<p><a class="el" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga6819f7761fc3505c4f885653ff8121f0" title="Function to cancel SPI transactions. ">SPI_transferCancel()</a> is used to cancel a SPI transaction - not supported.</p>
<div class="fragment"><div class="line"><a class="code" href="group___s_p_i___d_r_i_v_e_r___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga6819f7761fc3505c4f885653ff8121f0">SPI_transferCancel</a>(handle);</div></div><!-- fragment --><h1>Implementation</h1>
<p>This module serves as the main interface for TI-RTOS applications. Its purpose is to redirect the module's APIs to specific peripheral implementations which are specified using a pointer to a SPI_FxnTable.</p>
<p>The SPI driver interface module is joined (at link time) to a NULL-terminated array of SPI_Config data structures named <em>SPI_config</em>. <em>SPI_config</em> is implemented in the application with each entry being an instance of a SPI peripheral. Each entry in <em>SPI_config</em> contains a:</p><ul>
<li>(SPI_FxnTable *) to a set of functions that implement a SPI peripheral</li>
<li>(void *) data object that is associated with the SPI_FxnTable</li>
<li>(void *) hardware attributes that are associated to the SPI_FxnTable</li>
</ul>
<h1>SPI transfer with multiple RAM buffer (icount)</h1>
<p>SPI hardware has an internal RAM buffer that stores transmit/receive data element in 8bits or 16bits. The SPI driver has a compile time option to transfer data bigger than RAM buffer size. This is intended for high throughput transfers. But it has some limitations and not supported in all SPI modes.</p>
<table class="doxtable">
<tr>
<th>SPI mode </th><th>Pin Mode </th><th>Supported? </th><th>Limitations  </th></tr>
<tr>
<td>Master </td><td>4-pin </td><td>Yes </td><td>Note1 </td></tr>
<tr>
<td>Master </td><td>3-pin </td><td>Yes </td><td>Note1 </td></tr>
<tr>
<td>Slave </td><td>4-pin </td><td>Yes </td><td>Note2 </td></tr>
<tr>
<td>Slave </td><td>3-pin </td><td>No </td><td>None </td></tr>
</table>
<p>Note1: There will be gaps between every transfer of the RAM buffer size for internal DMA copy of the data. During this time, Clock and CS will be inactive.</p>
<p>Note2: Slave needs time to do DMA copy of received data for every RAM buffer. Hence require the SPI master to deactivate CS/ClK signal during this time. When using another XWR1xxx device as master, it can be achieved by setting C2Tdelay/T2Cdelay/wdelay.</p>
<p>The maximum elements is defined as MIBSPI_RAM_MAX_ELEM. For multiple slaves scenarios, this number is divided among all slaves. This information is provided from application in SPI_MasterModeParams. The maximum icount value is 32. Please make sure the transfer length is not exceed 32 * ramLen. For High clock rate, it is recommended to use small icount values.</p>
<h1>Limitation</h1>
<h1>Instrumentation</h1>
<p>The SPI driver interface produces log statements if instrumentation is enabled.</p>
<table class="doxtable">
<tr>
<th>Diagnostics Mask </th><th>Log details  </th></tr>
<tr>
<td>Diags_USER1 </td><td>basic operations performed </td></tr>
<tr>
<td>Diags_USER2 </td><td>detailed operations performed </td></tr>
</table>
<hr/>
 </div></div><!-- contents -->
<hr size="1"><small>
Copyright  2018, Texas Instruments Incorporated</small>
</body>
</html>
