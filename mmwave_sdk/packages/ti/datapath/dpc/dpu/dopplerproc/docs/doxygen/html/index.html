<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Doppler DPU</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table width=100%>
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border=0 src="../../tilogo.gif"></a></td>
  <td bgcolor="red"><img src="../../titagline.gif"></td>
</tr>
</table>
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Doppler DPU </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This DPU implements the Doppler FFT (2D FFT) using HWA.<br />
This DPU expects as input the radar cube with 1D FFT data as described in <a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>. The output of this DPU is a detection matrix of format described in <a class="el" href="group___d_p_i_f___d_e_t_m_a_t_r_i_x___f_o_r_m_a_t.html#gaaa138fe4aad1ad2db607a5fd68f82415">DPIF_DETMATRIX_FORMAT_1</a>. These are the only formats supported by this DPU. Data from radar cube is moved into HWA memory using EDMA, HWA performs the required computations and data is moved by EDMA from HWA internal memory to the detection matrix.<br />
<br />
 The following figure shows a high level block diagram of the DPU implementation.<br />
 </p><div class="image">
<img src="hwa_doppler_toplevel.png" alt="hwa_doppler_toplevel.png"/>
<div class="caption">
HWA based Doppler DPU High Level block diagram</div></div>
<p> A list of resources required by this DPU is described in <a class="el" href="struct_d_p_u___doppler_proc_h_w_a___h_w___resources__t.html">DPU_DopplerProcHWA_HW_Resources_t</a>. In particular, the number of EDMA channels required is constant and does not depend on the data path configuration. On the other hand, the number of required HWA paramsets is a function of the number of TX antennas configured in the data path as described in <a class="el" href="struct_d_p_u___doppler_proc_h_w_a___hwa_cfg__t.html">DPU_DopplerProcHWA_HwaCfg_t</a>.<br />
 Besides the resources described above, other parameters required for the DPU configuration are listed in <a class="el" href="struct_d_p_u___doppler_proc_h_w_a___static_config__t.html">DPU_DopplerProcHWA_StaticConfig_t</a>. In particular, the DPU takes as input the number of Doppler chirps (numDopplerChirps), which does not need to be a power of two. It produces a detection matrix of Doppler dimension equal to numDopplerBins which must be a power of 2 greater or equal than numDopplerChirps. Another DPU input is the number of range bins, which must be even but does not need to be a power of two.<br />
<br />
 Below are details of the DPU implementation:<br />
 EDMA is used to move data from the radar cube into the HWA internal memory and after processing is done to move data from HWA internal memory to the detection matrix. All 4 HWA memory banks are required by this DPU, regardless of the DPU configuration. In this document, the HWA memory banks are called M0, M1, M2, M3.<br />
</p>
<p>A ping/pong buffer scheme is used where:<br />
 M0 and M2 are used for ping input/processing.<br />
 M1 and M3 are used for pong input/processing.<br />
 In each iteration (ping/pong), a column of the radar cube matrix is brought into HWA for processing. Such column consists of all samples for a fixed range, that is, all received virtual antennas for all Doppler chirps for a fixed range bin.<br />
 The steps below are executed by HWA on data (one column of the radar cube as described above) sitting in its M memory. The description below is given for processing the ping buffer. Pong buffer processing is identical to ping, except that M0 memory is replaced by M1 and M2 memory is replaced by M3.<br />
<br />
 <b>Windowing</b><br />
Before FFT operation, input samples are multiplied by a window function. Window size and coefficients are defined in <a class="el" href="struct_d_p_u___doppler_proc_h_w_a___hwa_cfg__t.html">DPU_DopplerProcHWA_HwaCfg_t</a>.<br />
Window coefficients must be provided by application.<br />
<br />
 <b>FFT and Log2|.|</b><br />
In this step 2D FFT and Log2 of the absolute value of each sample is computed. Input samples are in M0 and output samples are in M2. Input sample is of type cmplx16ImRe_t and output is of type uint16_t. This step also converts the number of input samples from N = numDopplerChirps to a number of output samples K = numDopplerBins, which is the size of the Doppler FFT. Both numDopplerBins and numDopplerChirps are input parameters for this DPU and numDopplerBins must be a power of 2 greater or equal than numDopplerChirps. <br />
<br />
</p>
<p><b>Summation</b><br />
Summation of all virtual antennas is computed for each Doppler bin. <br />
The output of the previous step (HWA Log2 magnitude) is in Q11 format. The sum is done using FFT in HWA, the sum is obtained in the DC (0th) bin. Input of the summation is on M2 and output is on M0. This FFT programming has srcScale of 2, meaning 2 redundant bits (sign extension, in this case unsigned) are added to MSB and 6 LSBs are padded with 0, so input before computation is in Q[11 + 6] format. The dstScale is set to 8, so summation output will have 8-bits dropped, giving a result in Q[11 + 6 - 8] = Q9 format. The FFT size is the next power of 2 of number of virtual antennas and the FFT is programmed to enable all butterfly scaling stages, hence the FFT output will be 1/A * sum(.), where A = 2^Ceil(Log2(numVirtualAntennas)). The true average is 1/numVirtualAntennas * sum(.). If numVirtualAntennas is a power of 2, A = numVirtualAntennas. Otherwise, a correction factor needs to be applied to every element of the detection matrix. This correction can be done by adjusting the CFAR threshold to compensate for this mismatch. Once the summation is computed for all Doppler bins, EDMA transfers the result from M0 to the detection matrix.<br />
<br />
 <b>HWA memory bank size limitation</b><br />
The following 2 conditions must be satisfied for the parameters in this DPU configuration:<br />
4 x numRxAntennas x numTxAntennas x numDopplerChirps &lt;= 16384<br />
2 x numRxAntennas x numTxAntennas x numDopplerBins &lt;= 16384<br />
<br />
 The reason for this limitation is as follows:<br />
The size of the data that is brought in for processing in HWA (per ping/pong iteration) is a column of the radar cube. The size of radar cube column is<br />
 4 x numRxAntennas x numTxAntennas x numDopplerChirps (I),<br />
where 4 bytes is sizeof(cmplx16ImRe_t), the sample size.<br />
 After the 2D FFT and Log2|.| , we go from Doppler chirps to Doppler bins and from cmplx16ImRe_t to uint16_t. <br />
 Therefore the size after 2D FFT and Log2|.| is<br />
 2 x numRxAntennas x numTxAntennas x numDopplerBins (II),<br />
where 2 bytes is sizeof(uint16_t).<br />
<br />
 Both quantities above (I and II) should fit (independently) in one of the HWA M memory partitions which has a size of 16KB.<br />
<br />
 <b>Exported APIs</b><br />
DPU initialization is done through <a class="el" href="group___d_p_u___d_o_p_p_l_e_r_p_r_o_c_h_w_a___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga28ac91fad2713702621dc60b2bc584e6">DPU_DopplerProcHWA_init</a>.<br />
<br />
 DPU configuration is done by <a class="el" href="group___d_p_u___d_o_p_p_l_e_r_p_r_o_c_h_w_a___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga20bf5ab5ea54cd9614c2c74bf0a786b7">DPU_DopplerProcHWA_config</a>. The configuration can only be done after the DPU has been initialized. The configuration parameters are described in <a class="el" href="group___d_p_u___d_o_p_p_l_e_r_p_r_o_c_h_w_a___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga773c45330ee7c15b7a3b4b954d02c8d2">DPU_DopplerProcHWA_Config</a>. <br />
<br />
 The DPU is executed by calling <a class="el" href="group___d_p_u___d_o_p_p_l_e_r_p_r_o_c_h_w_a___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#gae2fda7b20c66b6eda41082912faf0948">DPU_DopplerProcHWA_process</a>. <br />
This will trigger the first ping/pong EDMA transfers and from there on, the processing of the Doppler DPU for the full radar cube is driven by hardware: EDMA will move data in and trigger HWA, which will process the data and trigger EDMA to move data out (to detection matrix) and trigger next EDMA to move data in – and so on. All columns of the radar cube matrix will be processed in this loop and no CPU intervention is needed. When HWA finishes processing all columns of the radar cube it will generate an interrupt. When the last EDMA transfer to the detection matrix has landed, EDMA will generate an interrupt. The DPU processing is done when both interrupts are received. Both interrupts are depicted in green boxes in the figure below.<br />
<br />
</p>
<p><b>Detailed block diagram for 3 TX 4 RX</b><br />
 The following figure depicts in detail the DPU implementation for the case of 3 TX and 4RX antennas. The blue boxes connected by blue arrows represent different HWA paramsets.<br />
<br />
 </p><div class="image">
<img src="hwa_doppler_fft.png" alt="hwa_doppler_fft.png"/>
<div class="caption">
Doppler DPU implementation for 3 TX and 4 RX antennas</div></div>
</div></div><!-- contents -->
<hr size="1"><small>
Copyright  2018, Texas Instruments Incorporated</small>
</body>
</html>
