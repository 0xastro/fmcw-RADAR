<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HWA-AOA DPU</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table width=100%>
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border=0 src="../../tilogo.gif"></a></td>
  <td bgcolor="red"><img src="../../titagline.gif"></td>
</tr>
</table>
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">HWA-AOA DPU </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_HWA-AOA"></a>
HWA-AOA DPU</h1>
<h2><a class="anchor" id="section_AOA_Description"></a>
Description</h2>
<p>This DPU implements angle of arrival (AoA) estimation using HWA and CPU. It generates information about detected objects, into two lists: 1) list with coordinates defined by <a class="el" href="struct_d_p_i_f___point_cloud_cartesian__t.html">DPIF_PointCloudCartesian_t</a> and 2) side information list defined by <a class="el" href="struct_d_p_i_f___point_cloud_side_info__t.html">DPIF_PointCloudSideInfo_t</a>. The DPU receives 1D-FFT Radar Cube matrix calculated by range processing DPU and the list of detected objects (<a class="el" href="struct_d_p_i_f___c_f_a_r_det_list__t.html">DPIF_CFARDetList_t</a>) which is assumed to be populated by previous CFAR algorithm processing. A high level data flow is illustrated in figure below.</p>
<div class="image">
<img src="hwa_aoa_top_level.png" alt="hwa_aoa_top_level.png"/>
<div class="caption">
HWA-AOA high level data flow</div></div>
<p> The following figure depicts detailed DPU implementation. DPU processes data from the input CFAR detection list in chunks to overcome HWA memory limitation. In the loop per chunk, it reads group of detected objects from the input list, performs the processing, and appends the result to the output lists. The processing per chunk of detected objects consists of three phases:</p><ol type="1">
<li><p class="startli">Calculation of the array of 2D-FFT Rx virtual antenna symbols as input to Azimuth FFT computation. Processing is done in the loop for all objects within chunk. Each loop consists of following steps:</p><ol type="a">
<li>Input EDMA pages from radarCube memory to HWA M1 memory the data corresponding to the range index of the detected object. Note the input size limiting condition: <img class="formulaInl" alt="$N_{TxAnt}*N_{RxAnt}*N_{DopplerChirps}*sizeof(cmplx16ImRe\_t) \leq 16\;KB$" src="form_0.png"/></li>
<li>HWA calculates 2D FFT from M1 memory and produces output in M2+M3 memory. Note the output size limiting condition: <img class="formulaInl" alt="$N_{TxAnt}*N_{RxAnt}*N_{DopplerBins}*sizeof(cmplx16ImRe\_t) \leq 32\;KB$" src="form_1.png"/></li>
<li>Output EDMA picks the data of the Doppler bin corresponding to the detected object's Doppler index from the above FFT output and copies into core local memory.</li>
<li>CPU performs Rx channel phase/gain compensation on above data in core local memory and produces results in core local memory.</li>
<li>CPU performs Doppler compensation and writes result to the HWA M0 memory, where it holds symbols of both azimuth and elevation Tx antennas.</li>
</ol>
<p class="startli">Thus, at the end of this processing, the M0 will hold the azimuth and elevation 2D FFT output data of all detected objects.</p>
</li>
<li><p class="startli">Azimuth FFT calculation using HWA for all detected objects within chunk. In the loop for each detected object, the HWA calculates:</p><ol type="a">
<li>Azimuth FFT (complex output) on elevation Tx antennas in M0 to M3 only when 3 Tx antennas are configured.</li>
<li>Azimuth FFT on azimuth Tx antennas in M0 and then log2 magnitude of this FFT to M2.</li>
<li>Azimuth FFT (complex output) on azimuth Tx antennas in M0 to M1 only when 3 Tx antennas are configured.</li>
</ol>
<p class="startli">Note that the maximum number of detected objects per chunk is limited due to HWA memory size: <img class="formulaInl" alt="$N_{objPerChunk} \leq 16\;KB / (sizeof(cmplx16ImRe\_t) * N_{AngleFFT})$" src="form_2.png"/> when 3Tx antennas are configured, and <img class="formulaInl" alt="$N_{objPerChunk} \leq 16\;KB / (sizeof(uint16\_t) * N_{AngleFFT})$" src="form_3.png"/> when 2Tx antennas are configured.</p>
</li>
<li>Final azimuth and elevation estimation and x/y/z calculation performed by CPU. The calculated data of detected objects is appended to the output lists.</li>
</ol>
<div class="image">
<img src="hwa_aoa.png" alt="hwa_aoa.png"/>
<div class="caption">
HWA-AOA implementation (for 3 Tx antennas)</div></div>
<p> In addition to AoA estimation, this DPU also generates data for computing azimuth heat-map (e.g for visualization purposes), this data is 2D FFT of the phase compensated Doppler bin 0 (static objects) output of each of the range bins. The following figure depicts data generation for azimuth heat-map visualization.</p>
<div class="image">
<img src="hwa_aoa_azimuth_heatmap.png" alt="hwa_aoa_azimuth_heatmap.png"/>
<div class="caption">
HWA-AOA implementation</div></div>
 <h2><a class="anchor" id="Sect_dopplerComp"></a>
Doppler Compensation</h2>
<p>Doppler compensation function (<a class="el" href="group___d_p_u___a_o_a_p_r_o_c___i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga1ee48467e34aec50a25d301c1d754004">aoaHwa_dopplerCompensation</a>) is done by CPU after Rx channel phase/gain compensation. It performs compensation for the Doppler phase shift on the symbols corresponding to the virtual Rx antennas. In case of 2Tx MIMO scheme, the second set of Rx symbols is rotated by half of the estimated Doppler phase shift between subsequent chirps corresponding to the same Tx antenna. In case of 3Tx MIMO elevation scheme, the second set of Rx symbols is rotated by 1/3 of the estimated Doppler phase shift, while the third set of Rx symbols is rotated by 2/3 of the estimated Doppler phase shift. Refer to the pictures below. <a class="anchor" id="Figure_doppler"></a> </p><div class="image">
<img src="angle_doppler_compensation.png" alt="angle_doppler_compensation.png"/>
<div class="caption">
Figure_doppler: Doppler Compensation</div></div>
 <h2><a class="anchor" id="dataXYZ"></a>
Data Path - Direction of Arrival Estimation (x,y,z)</h2>
<p>This processing is done on CPU in the function <a class="el" href="group___d_p_u___a_o_a_p_r_o_c___i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga1108d26c82bbc317fc2f8fbc342eccae">AoAProcHWA_angleEstimationAzimElev</a>. The actual computation per detected object is performed by <a class="el" href="group___d_p_u___a_o_a_p_r_o_c___i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga803df44da11a775618764f6b2c9f6387">AoAProcHWA_XYZestimation</a>. <a class="anchor" id="Figure_geometry"></a> </p><div class="image">
<img src="coordinate_geometry.png" alt="coordinate_geometry.png"/>
<div class="caption">
Figure A: Coordinate Geometry</div></div>
<p> <br />
<a class="anchor" id="Figure_wz"></a> </p><div class="image">
<img src="coordinate_geometry_wz.png" alt="coordinate_geometry_wz.png"/>
<div class="caption">
Figure wz</div></div>
<p> <br />
<a class="anchor" id="Figures_wx"></a> </p><div class="image">
<img src="coordinate_geometry_wx.png" alt="coordinate_geometry_wx.png"/>
<div class="caption">
Figures wx</div></div>
<p> <a class="el" href="index.html#Figure_geometry">Figure_geometry</a> shows orientation of x,y,z axes with respect to the sensor/antenna positions. The objective is to estimate the (x,y,z) coordinates of each detected object. <img class="formulaInl" alt="$w_x$" src="form_4.png"/> is the phase difference between consecutive receive azimuth antennas of the 2D FFT and <img class="formulaInl" alt="$w_z$" src="form_5.png"/> is the phase difference between azimuth and corresponding elevation antenna above the azimuth antenna. The phases for each antenna are shown in the <a class="el" href="index.html#Figure_doppler">Figure_doppler</a>. <a class="el" href="index.html#Figure_wz">Figure_wz</a> shows that the distance AB which represents the relative distance between wavefronts intersecting consecutive elevation antennas is <img class="formulaInl" alt="$AB = \frac{\lambda}{2} \sin (\phi)$" src="form_6.png"/>. Therefore <img class="formulaInl" alt="$W_z = \frac{2\pi}{\lambda} \cdot AB$" src="form_7.png"/>, therefore <img class="formulaInl" alt="$W_z = \pi \sin (\phi)$" src="form_8.png"/>. Note that the phase of the lower antenna is advanced compared to the upper antenna which is why picture X shows -Wz term in the upper antenna. <a class="el" href="index.html#Figures_wx">Figures_wx</a> show that distance CD which represents the relative distance between wavefronts intersecting consecutive azimuth antennas is <img class="formulaInl" alt="$CD = \frac{\lambda}{2} \sin (\theta) \cos (\phi)$" src="form_9.png"/> Therefore <img class="formulaInl" alt="$w_x = \frac{2\pi}{\lambda} \cdot CD$" src="form_10.png"/>, therefore <img class="formulaInl" alt="$w_x = \pi \sin (\theta) \cos (\phi)$" src="form_11.png"/>. For a single obstacle, the signal at the 8 azimuth antennas will be ( <img class="formulaInl" alt="$A_1$" src="form_12.png"/> and <img class="formulaInl" alt="$\psi$" src="form_13.png"/> are the arbitrary starting amplitude/phase at the first antenna): </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ A_1 e^{j\psi} [ 1 \; e^{jw_x} \; e^{j2w_x} \; e^{j3w_x} \; e^{j4w_x} \; e^{j5w_x} \; e^{j6w_x} \; e^{j7w_x} ] \]" src="form_14.png"/>
</p>
<p>An FFT of the above signal will yield a peak <img class="formulaInl" alt="$P_1$" src="form_15.png"/> at <img class="formulaInl" alt="$w_x$" src="form_4.png"/>, with the phase of this peak being <img class="formulaInl" alt="$\psi$" src="form_13.png"/> i.e </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ P_1 = A_1 e^{j\psi} \]" src="form_16.png"/>
</p>
<p> If <img class="formulaInl" alt="$k_{MAX}$" src="form_17.png"/> is the index of the peak in log magnitude FFT represented as signed index in range <img class="formulaInl" alt="$[-\frac{N}{2}, \frac{N}{2}-1]$" src="form_18.png"/>, then <img class="formulaInl" alt="$ w_x $" src="form_19.png"/> will be </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_x = \frac{2\pi}{N}k_{MAX} \]" src="form_20.png"/>
</p>
<p>The signal at the 4 elevation antennas will be: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ A_2 e^{j(\psi + 2 w_x - w_z)} [ 1 \; e^{jw_x} \; e^{j2w_x} \; e^{j3w_x}] \]" src="form_21.png"/>
</p>
<p>An FFT of the above signal will yield a peak <img class="formulaInl" alt="$P_2$" src="form_22.png"/> at <img class="formulaInl" alt="$w_x$" src="form_4.png"/>, with the phase of this peak being <img class="formulaInl" alt="$\psi + 2w_x - w_z$" src="form_23.png"/>. </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ P_2 = A_2 e^{j(\psi+ 2 w_x - w_z)} \]" src="form_24.png"/>
</p>
<p>From above, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ P_1 \cdot P_2^* = A_1 \cdot A_2 e^{j(\psi - (\psi+ 2 w_x - w_z))} \]" src="form_25.png"/>
</p>
<p>Therefore, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_z=\angle (P_1 \cdot P_2^* \cdot e^{j2w_x}) \]" src="form_26.png"/>
</p>
<p>Calculate range (in meters) as: </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ R=k_r\frac{c \cdot F_{SAMP}}{2 \cdot S \cdot N_{FFT}} \]" src="form_27.png"/>
</p>
<p> where, <img class="formulaInl" alt="$c$" src="form_28.png"/> is the speed of light (m/sec), <img class="formulaInl" alt="$k_r$" src="form_29.png"/> is range index, <img class="formulaInl" alt="$F_{SAMP}$" src="form_30.png"/> is the sampling frequency (Hz), <img class="formulaInl" alt="$S$" src="form_31.png"/> is chirp slope (Hz/sec), <img class="formulaInl" alt="$N_{FFT}$" src="form_32.png"/> is 1D FFT size. Based on above calculations of <img class="formulaInl" alt="$R$" src="form_33.png"/>, <img class="formulaInl" alt="$w_x$" src="form_4.png"/> and <img class="formulaInl" alt="$w_z$" src="form_5.png"/>, the <img class="formulaInl" alt="$(x,y,z)$" src="form_34.png"/> position of the object can be calculated as seen in the <a class="el" href="index.html#Figure_geometry">Figure_geometry</a>, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ x = R\cos(\phi)\sin(\theta) = R\frac{w_x}{\pi}, \;\;\;\;\; z = R\sin(\phi) = R\frac{w_z}{\pi},\;\;\;\;\; y = \sqrt{R^2-x^2-z^2} \]" src="form_35.png"/>
</p>
<p> The computed <img class="formulaInl" alt="$(x,y,z)$" src="form_34.png"/> along with the Doppler value for each detected object are populated in the output list, structured as <a class="el" href="struct_d_p_i_f___point_cloud_cartesian__t.html">DPIF_PointCloudCartesian_t</a>.</p>
<p>If the multi object beam forming feature is enabled, (it can be dynamically controlled from CLI), the algorithm searches for the second peak in the azimuth FFT output and compares its height relative to the first peak height, and if detected, it creates new object in the output list with the same Doppler value and calculated (x,y,z) coordinates.</p>
<h2><a class="anchor" id="fovSubSection"></a>
Elimination of detected objects based on FoV limits</h2>
<p>The AoA DPU filters out detected objects whose azimuth, <img class="formulaInl" alt="$\theta$" src="form_36.png"/>, and elevation, <img class="formulaInl" alt="$\phi$" src="form_37.png"/>, angles are not within configured FoV limits. The DPU receives the following FoV parameters:</p>
<p><img class="formulaInl" alt="$\phi_{min},\;\phi_{max},$" src="form_38.png"/> - elevation angle FoV limits</p>
<p><img class="formulaInl" alt="$\theta_{min},\;\theta_{max}$" src="form_39.png"/> - azimuth angle FoV limits</p>
<p>The DPU computes <img class="formulaInl" alt="$W_z$" src="form_40.png"/> and <img class="formulaInl" alt="$W_x$" src="form_41.png"/> directly from azimuth FFT output data, where</p>
<p><img class="formulaInl" alt="$W_z = w_z/\pi$" src="form_42.png"/></p>
<p><img class="formulaInl" alt="$W_x = w_x/\pi$" src="form_43.png"/></p>
<p>From equations in previous section the following holds</p>
<p><img class="formulaInl" alt="$W_z = \sin(\phi)$" src="form_44.png"/></p>
<p><img class="formulaInl" alt="$W_x = \cos(\phi) \sin(\theta)$" src="form_45.png"/></p>
<p>Because sine is a monotonic increasing function in the maximum possible range of -90 deg, 90 deg, the elevation angle <img class="formulaInl" alt="$\phi$" src="form_37.png"/> FoV limits can be checked on <img class="formulaInl" alt="$W_z$" src="form_40.png"/> as follows</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sin(\phi_{min}) \leq W_z \leq \sin(\phi_{max}) \]" src="form_46.png"/>
</p>
<p>Since <img class="formulaInl" alt="$W_x$" src="form_41.png"/> is not monotonic in <img class="formulaInl" alt="$\phi$" src="form_37.png"/> but monotonic on <img class="formulaInl" alt="$\theta$" src="form_36.png"/>, the azimuth angle <img class="formulaInl" alt="$\theta$" src="form_36.png"/> limits can be checked by checking <img class="formulaInl" alt="$W_x$" src="form_41.png"/> after computing the <img class="formulaInl" alt="$\cos(\phi)$" src="form_47.png"/> on the measured <img class="formulaInl" alt="$\phi$" src="form_37.png"/>.</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \cos(\phi)\sin(\theta_{min}) \leq W_x \leq \cos(\phi) \sin(\theta_{max}) \]" src="form_48.png"/>
</p>
<p>where <img class="formulaInl" alt="$\cos(\phi) = \sqrt{1 - \sin(\phi)^2} = \sqrt{1 - W_z^2}$" src="form_49.png"/>. Note that the terms <img class="formulaInl" alt="$\sin(\phi_{min})$" src="form_50.png"/>, <img class="formulaInl" alt="$\sin(\phi_{max})$" src="form_51.png"/>, <img class="formulaInl" alt="$\sin(\theta_{min})$" src="form_52.png"/> and <img class="formulaInl" alt="$\sin(\theta_{max})$" src="form_53.png"/> are precomputed during configuration time and stored in the dpu's instance (<a class="el" href="struct_d_p_u___ao_a_proc__fov_aoa_local_cfg__t.html">DPU_AoAProc_fovAoaLocalCfg_t</a>) to be used in the real-time limit checks above. The brute-force method of checking limits on <img class="formulaInl" alt="$\phi$" src="form_37.png"/> and <img class="formulaInl" alt="$\theta$" src="form_36.png"/> directly requires computing these, which involves two sin inverses, one cosine and one division which are computationally more expensive than the above method.</p>
<h1><a class="anchor" id="api_section"></a>
AoAProcHWA APIs</h1>
<ul>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9c3e52c665e4e1d501ee8ed61f881746">DPU_AoAProcHWA_init</a> - DPUs initialization function.</li>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9e559182530f1b8d5b770eddc1972cba">DPU_AoAProcHWA_config</a> - DPUs configuration function. The configuration can only be done after the DPU has been initialized using <a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9c3e52c665e4e1d501ee8ed61f881746">DPU_AoAProcHWA_init</a>. If the parameters used by this DPU do not change from one frame to the next, this function can be called only once, for the first frame, otherwise it has to be called before each <a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga3deb13c30620adfea71eed7319c59d80">DPU_AoAProcHWA_process</a>.</li>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga3deb13c30620adfea71eed7319c59d80">DPU_AoAProcHWA_process</a> - DPUs processing function performs AoA estimation of detected objects in the given frame. This processing can only be done after the DPU has been configured.</li>
<li><p class="startli"><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga27bd186d59e946b1154233daa385e873">DPU_AoAProcHWA_control</a> - DPUs control function. It processes following messages from DPC:</p><ul>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggadc90ce1d3b0754d35e654a90e75cbb03a14bbb6dcb894addb4129913569fcceda">DPU_AoAProcHWA_Cmd_FovAoACfg</a>,</li>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggadc90ce1d3b0754d35e654a90e75cbb03a9de4da31c858ab558b0ac0c44c9f8f5b">DPU_AoAProcHWA_Cmd_MultiObjBeamFormingCfg</a>,</li>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggadc90ce1d3b0754d35e654a90e75cbb03a0244a1c7e048283f4d3c2e69c90099ab">DPU_AoAProcHWA_Cmd_CompRxChannelBiasCfg</a>,</li>
<li><a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggadc90ce1d3b0754d35e654a90e75cbb03aa8173743c13e52505e938b0836320904">DPU_AoAProcHWA_Cmd_PrepareRangeAzimuthHeatMap</a></li>
</ul>
<p class="startli">Full API details can be seen at <a class="el" href="group___d_p_u___a_o_a_p_r_o_c___e_x_t_e_r_n_a_l.html">aoaProcHWA DPU External</a> </p>
</li>
</ul>
</div></div><!-- contents -->
<hr size="1"><small>
Copyright  2018, Texas Instruments Incorporated</small>
</body>
</html>
