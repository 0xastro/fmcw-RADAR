<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RangeProc DPU</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table width=100%>
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border=0 src="../../tilogo.gif"></a></td>
  <td bgcolor="red"><img src="../../titagline.gif"></td>
</tr>
</table>
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">RangeProc DPU </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This DPU implements range processing using hardware accelerator(HWA) and DSP.</p>
<h1><a class="anchor" id="intro_section"></a>
Introduction</h1>
<h2>Description </h2>
<p>Range Processing Unit takes RF data in ADC buffer, computes 1D FFT and saves results in radarCube in the requested format.</p>
<p>Range Processing includes two DPU implementations:</p>
<table class="doxtable">
<tr>
<th align="left">DPU </th><th align="left">runs on cores  </th></tr>
<tr>
<td align="left">rangeProcHWA</td><td align="left">R4F or DSP </td></tr>
<tr>
<td align="left">rangeProcDSP</td><td align="left">DSP </td></tr>
</table>
<h2>Data Interface </h2>
<p>Range processing only supports 16bits complex data in ImRe format (<a class="el" href="dpif__types_8h.html#acb5c148ad8168d6c470826f5ea11b603aa799a265f231047c07903f98335a97f7">DPIF_DATAFORMAT_COMPLEX16_IMRE</a>).<br />
 Range processing data Input interface is defined by <a class="el" href="struct_d_p_i_f___a_d_c_buf_data__t.html">DPIF_ADCBufData_t</a>.<br />
 Range processing data Output interface is define by <a class="el" href="struct_d_p_i_f___radar_cube__t.html">DPIF_RadarCube_t</a>.<br />
 The parameters for radarCube are defined in <a class="el" href="struct_d_p_u___range_proc_h_w_a___static_config__t.html">DPU_RangeProcHWA_StaticConfig_t</a> or <a class="el" href="struct_d_p_u___range_proc_d_s_p___static_config__t.html">DPU_RangeProcDSP_StaticConfig_t</a>.</p>
<p>Both rangeProcHWA and rangeProcDSP has the same data interface as described above. However rangeProcHWA supports more input and output formats. Refer to each DPU for more details.</p>
<h2>Antenna Coupling Signature Removal </h2>
<p>Antenna coupling signature dominates the range bins close to the radar. These are the bins in the range FFT output located around DC.</p>
<p>This feature can be enabled/disabled through configuration <a class="el" href="struct_d_p_u___range_proc___calib_dc_range_sig_cfg__t.html">DPU_RangeProc_CalibDcRangeSigCfg_t</a> at configure time or at run time.</p>
<p>After the feature is enabled, it does measurements for <a class="el" href="struct_d_p_u___range_proc___calib_dc_range_sig_cfg__t.html#a2f9dba4d1c381782e943fb70d9b766a4">DPU_RangeProc_CalibDcRangeSigCfg_t::numAvgChirps</a> doppler chirps. During measurement, each of the specified range bins ([<a class="el" href="struct_d_p_u___range_proc___calib_dc_range_sig_cfg__t.html#aeaa32673d249fb14ea6b9f5e4ba1ad79">DPU_RangeProc_CalibDcRangeSigCfg_t::negativeBinIdx</a>, <a class="el" href="struct_d_p_u___range_proc___calib_dc_range_sig_cfg__t.html#a5aef9c8338d91b037b349413c288088f">DPU_RangeProc_CalibDcRangeSigCfg_t::positiveBinIdx</a>]) for each of the virtual antennas are accumulated over the specified number of chirps ("numAvgChirps") and at the end of the period, the average is computed for each range bin and each virtual antenna combination.</p>
<p>It is assumed that no objects are present in the vicinity of the radar during this measurement period. After measurement is done, the removal starts for all subsequent frames for each range bin and virtual antenna, average estimate is subtracted from the corresponding received samples in real-time for subsequent processing.</p>
<dl class="section note"><dt>Note</dt><dd>The number of chirps to average(numAvgChirps) must be power of 2.</dd></dl>
<h1><a class="anchor" id="dpu1"></a>
RangeProcHWA</h1>
<h2><a class="anchor" id="toplevel_hwa"></a>
Top Level Design</h2>
<p>Range FFT processing is done by HWA hardware. Based on the RF parameters, rangeProcHWA configures hardware accelerator FFT engine accordingly. It also configures data input and output EDMA channels to bring data in and out of range Processing memory.</p>
<p>HWA FFT process is triggered by hardware based trigger -"chirp data available" which is hooked up to HWA internally in hardware.</p>
<p>After FFT processing is done, HWA generates interrupt to rangeProcHWA DPU, at the same time triggers EDMA data output channel to copy FFT results to radarCube in configured format. EDMA interrupt done interrupt is triggered by EDMA hardware after the copy is completed.</p>
<p>DC antenna signal calibration and removal is built into the rangeProcHWA Module. If the feature is enabled, it is done after all chirps (in the frame) FFT processing is completed.</p>
<p>The following diagram shows the top level design for rangeProcHWA.</p>
<div class="image">
<img src="rangeprochwa_toplevel.png" alt="rangeprochwa_toplevel.png"/>
<div class="caption">
rangeProcHWA Top Level</div></div>
<p> The following diagram shows a general timing diagram for a 3 tx antenna MIMO case but can be imagined to hold for 1 or 2 tx cases as well. All use cases described in later sections have this general timing flow.</p>
<div class="image">
<img src="datapath_1d_timing.png" alt="datapath_1d_timing.png"/>
<div class="caption">
Timing Diagram</div></div>
 <h2><a class="anchor" id="config_hwa"></a>
Data Interface Parameter Range</h2>
<p>Here are supported ADCBuf and radarCube interface configurations:</p>
<h2>ADCBuf Data Interface </h2>
<table class="doxtable">
<tr>
<th align="left">Parameter </th><th align="center">Supported value  </th></tr>
<tr>
<td align="left">dataFmt </td><td align="center"><a class="el" href="dpif__types_8h.html#acb5c148ad8168d6c470826f5ea11b603aa799a265f231047c07903f98335a97f7">DPIF_DATAFORMAT_COMPLEX16_IMRE</a> only </td></tr>
<tr>
<td align="left">interleave</td><td align="center">interleave (<a class="el" href="dpif__adcdata_8h.html#a5a3c4d5f28cbdaf4e5f21d1a71bec7a2a6a3cf55cd8f377438ad6ee06aa9870fb">DPIF_RXCHAN_INTERLEAVE_MODE</a>) and non-interleave (<a class="el" href="dpif__adcdata_8h.html#a5a3c4d5f28cbdaf4e5f21d1a71bec7a2a9bc9d92e18630ecee50389baae437605">DPIF_RXCHAN_NON_INTERLEAVE_MODE</a>) </td></tr>
<tr>
<td align="left">numChirpsPerChirpEvent</td><td align="center">1 ONLY </td></tr>
<tr>
<td align="left">numRxAntennas</td><td align="center">1, 2 or 4 </td></tr>
<tr>
<td align="left">numAdcSamples</td><td align="center">64 - 1024 </td></tr>
</table>
<h2>Radar Cube Data Interface </h2>
<table class="doxtable">
<tr>
<th align="left">Parameter </th><th align="center">Supported value  </th></tr>
<tr>
<td align="left">datafmt </td><td align="center"><a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a> and <a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga52490164a754938e734d5b2fef66fe76">DPIF_RADARCUBE_FORMAT_2</a> only </td></tr>
<tr>
<td align="left">numTxAntennas</td><td align="center">1, 2 and 3 </td></tr>
<tr>
<td align="left">numRangeBins</td><td align="center">64 - 1024 </td></tr>
<tr>
<td align="left">numChirpsPerFrame</td><td align="center">As AdcBuf and HWA memory permit, numChirpsPerFrame/numTxAntennas should be an even number </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>For 1024 Range bins with 1 TX , 4 RX antenna and <a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>, it is not currently supported due to EDMA address jump limitation (jump &lt; 32768). </dd>
<dd>
For 1024 Range bins with 3 TX , 4 RX antenna and <a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>, it is not currently supported due to EDMA address jump limitation (jump &lt; 32768). </dd>
<dd>
Due to the Ping/Pong scheme implemented in rangeProcHWA DPU, numChirpsPerFrame/numTxAntennas should be an even number.</dd></dl>
<h2><a class="anchor" id="input_hwa"></a>
Data Input</h2>
<p>There are two HWA input mode supported (<a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gab1ef0718b68cc0f9fe4e36f17a72c067">DPU_RangeProcHWA_InputMode_e</a>),</p><ul>
<li><a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggab1ef0718b68cc0f9fe4e36f17a72c067a53dc67330cf43a64e5832dad39140aa0">DPU_RangeProcHWA_InputMode_ISOLATED</a> : <br />
 ADCBuf buffer and HWA memory are isolated in physical memory space. Data input EDMA channel is configured to transfer data from ADCBuf to HWA M0/M1 memory in ping/pong alternate order.</li>
<li><a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggab1ef0718b68cc0f9fe4e36f17a72c067a22c8a10984e4bfee8408bd7c24da07d9">DPU_RangeProcHWA_InputMode_MAPPED</a> :<br />
 ADCBuf buffer and HWA memory are mapped. HWA can read ADC data directly. No copy is needed.</li>
</ul>
<p>Depending on the RF configuration, the data in ADCBuf can be either interleaved or non-interleaved mode.</p>
<h2><a class="anchor" id="output_hwa"></a>
Data Output</h2>
<p>RangeProcHWA configures data output EDMA channels to transfer FFT results from HWA M2/M3 to radarCube memory.</p>
<p>The following two radarCube formats are supported in rangeProcHWA.</p><ul>
<li><a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a></li>
<li><a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga52490164a754938e734d5b2fef66fe76">DPIF_RADARCUBE_FORMAT_2</a></li>
</ul>
<p>The following table describes the suppoted data input and output combinations:</p>
<table class="doxtable">
<tr>
<th align="left">Interleave Mode </th><th align="center">DPIF_RADARCUBE_FORMAT_1 </th><th align="center">DPIF_RADARCUBE_FORMAT_2  </th></tr>
<tr>
<td align="left">interleave </td><td align="center">NOT supported </td><td align="center">Supported </td></tr>
<tr>
<td align="left">non-interleave</td><td align="center">Supported </td><td align="center">Supported </td></tr>
</table>
<h2><a class="anchor" id="process_hwa"></a>
Data Processing</h2>
<p>Range FFT processing is done by HWA hardware. As shown in the following diagram, after <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9e06daf8d20969470d0e622ed3335bc0">DPU_RangeProcHWA_config</a> is completed, in every frame, rangeProcHWA is triggered through <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga31b1c43fac7e0a8edb2f9fcc61e36561">DPU_RangeProcHWA_control</a> <br />
 using command <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga8c25dec4f8f383a3c745d8da510aad30a2018c7b6945733bb85135605f9de77d0">DPU_RangeProcHWA_Cmd_triggerProc</a>. If the hardware resources are overlaid with other modules, <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9e06daf8d20969470d0e622ed3335bc0">DPU_RangeProcHWA_config</a> can be called before the next frame start. <br />
 DC signal removal configuration can be updated at inter-frame time before the next frame starts.</p>
<div class="image">
<img src="hwa_callflow.png" alt="hwa_callflow.png"/>
<div class="caption">
rangeProcHWA call flow</div></div>
<h3><a class="anchor" id="hwa_calibDC_Range"></a>
Antenna coupling signature removal</h3>
<p>This feature is controlled through configuration <a class="el" href="struct_d_p_u___range_proc___calib_dc_range_sig_cfg__t.html">DPU_RangeProc_CalibDcRangeSigCfg_t</a>. The configuration can be sent to rangeProcHWA DPU through API <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga9e06daf8d20969470d0e622ed3335bc0">DPU_RangeProcHWA_config</a>. <br />
 The configuration can also be updated at runtime through control command <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga8c25dec4f8f383a3c745d8da510aad30af34aae3970e0bc617b14cd6885ab3caa">DPU_RangeProcHWA_Cmd_dcRangeCfg</a>.</p>
<p>DC signal calibration and compensation is operated on radarCube directly by the CPU.</p>
<div class="image">
<img src="hwa_dcremoval.png" alt="hwa_dcremoval.png"/>
<div class="caption">
rangeProcHWA Antenna DC signal removal</div></div>
<h2><a class="anchor" id="hwa_usecase"></a>
Use Cases and Implementation</h2>
<p>This Section describes some of the internal implementation for a few use cases with combination of input/output configurations. <br />
 </p>
<h3><a class="anchor" id="hwa_impl"></a>
HWA param set Implementation</h3>
<p>RangeProcHWA always use 4 consecutive HWA param sets(<a class="el" href="rangeprochwa_8h.html#ac725afeda9232deb7624d60a48309e9d">DPU_RANGEPROCHWA_NUM_HWA_PARAM_SETS</a>) starting from paramSetStartIdx, these params will be labeled PARAM_0, PARAM_1, PARAM_2 and PARAM_3 from now onwards for convenience of explanation and picture representation. Param sets are used in two parallel processing chain in ping/pong alternate manner. PARAM_0 and PARAM_1 are used for PING and PARAM_2 and PARAM_3 are used for PONG.</p>
<p>PARAM_0 and PARAM_2 need to be activated by triggers to protect internal data memory integrity. There are initially triggered by software when starting the very first chirp. Consequently they are triggered by data out hot signature channel. PARAM_1 and PARAM_3 are Range FFT param sets for PING and PONG respectively. In directly mapped input mode, they are triggered by frontend hardware when chirp data is available. In isolated input mode, they are triggered by data in hot signature. After range FFT processing is done in HWA, HWA param sets automatically trigger data out EDMA channel to copy data to radar Cube in desired radarCube format.</p>
<h3><a class="anchor" id="hwa_dataIn"></a>
EDMA Data In Implementation</h3>
<p>When enabled, data input EDMA is constructed utilizing two EDMA channels. The first EDMA channel copies data from ADCBuf buffer to HWA memory. The second EDMA channel is chained to the first channel. It copies hot signature to trigger range FFT param sets.<br />
 In summary, the data in EDMA requires the following resources: </p><pre class="fragment"> - 1 EDMA channel with 1 shadow channel
 - 1 hot Signature channel with 1 shadow channel
</pre><h3><a class="anchor" id="hwa_dataOut"></a>
EDMA Data Out Implementation</h3>
<p>Data out EDMA is responsible for copying data from HWA memory to radar Cube memory. It has two formats (<a class="el" href="struct_d_p_u___range_proc_h_w_a___e_d_m_a_output_config__t.html">DPU_RangeProcHWA_EDMAOutputConfig_t</a>).<br />
 <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga87a51448bb00e451c837b590df405150">DPU_RangeProcHWA_EDMAOutputConfigFmt2</a> is only for the following configuration: <br />
 </p><table class="doxtable">
<tr>
<th align="left">Setting </th><th align="center">Note  </th></tr>
<tr>
<td align="left"><a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a></td><td align="center">Radar Cube format 1 </td></tr>
<tr>
<td align="left">numTxAntenna</td><td align="center">3 TX antenna </td></tr>
<tr>
<td align="left"><a class="el" href="dpif__adcdata_8h.html#a5a3c4d5f28cbdaf4e5f21d1a71bec7a2a9bc9d92e18630ecee50389baae437605">DPIF_RXCHAN_NON_INTERLEAVE_MODE</a></td><td align="center">ADCBuf non interleave mode </td></tr>
</table>
<p>All other configurations should use <a class="el" href="struct_d_p_u___range_proc_h_w_a___e_d_m_a_output_config_fmt1__t.html">DPU_RangeProcHWA_EDMAOutputConfigFmt1_t</a>.</p>
<p>For EDMA dataOut Fmt1, it needs three EDMA channels, shown as follows: </p><pre class="fragment"> Ping:
 - 1 EDMA channel with 1 shadow channel

 Pong:
 - 1 EDMA channel with 1 shadow channel

 Signature channel:
 - 1 HWA hot signature channel with 1 shadow channel
</pre><p>Ping and Pong EDMA channels are triggered by PARAM_1 and PARAM_3 FFT automatically. Both Ping/pong EDMA channels are chained to data out Hot Signature channel, which triggers HWA PARAM_0 AND PARAM_2 when EDMA channel copy is completed.</p>
<p>For EDMA dataOut Fmt2, it requires the following resources:<br />
</p><pre class="fragment"> Ping:
 - 1 dummy EDMA channel with 3 shadow channels
 - 3 dataOut channel, each has a shadow channel

 Pong:
 - 1 dummy EDMA channel with 3 shadow channels
 - 3 dataOut channel, each has a shadow channel

 Signature channel:
 - 1 HWA hot signature channel with 1 shadow channel
</pre><p>The dummy EDMA channel is triggered by the HWA PARAM_1(trigger data out Ping EDMA channel) and PARAM_3(trigger data out pong EDMA channel) after FFT operation is completed. The dummy channel is linked to 3 shadow channels. The shadow channel is loaded to dummy channel in round robin order. Each dummy channel is chained to one of the 3 dataOut channel that have different source and destination address. Details are as follows:</p>
<table class="doxtable">
<tr>
<th align="center">Index </th><th align="center">Source Address </th><th align="center">Destination Address </th><th align="center">sequence order in time  </th></tr>
<tr>
<td align="center">PING 1</td><td align="center">HWA M2 </td><td align="center">TX1 </td><td align="center">1 </td></tr>
<tr>
<td align="center">PING 2</td><td align="center">HWA M2 </td><td align="center">TX3 </td><td align="center">3 </td></tr>
<tr>
<td align="center">PING 3</td><td align="center">HWA M2 </td><td align="center">TX2 </td><td align="center">5 </td></tr>
<tr>
<td align="center">PONG 1</td><td align="center">HWA M3 </td><td align="center">TX2 </td><td align="center">2 </td></tr>
<tr>
<td align="center">PONG 2</td><td align="center">HWA M3 </td><td align="center">TX1 </td><td align="center">4 </td></tr>
<tr>
<td align="center">PONG 3</td><td align="center">HWA M3 </td><td align="center">TX3 </td><td align="center">6 </td></tr>
</table>
<h2>Interleaved RX channel data -&gt; DPIF_RADARCUBE_FORMAT_2 </h2>
<p>This use case is for configuration with a directly mapped input buffer with interleaved ADC data. After Range FFT, data is saved in radar cube with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga52490164a754938e734d5b2fef66fe76">DPIF_RADARCUBE_FORMAT_2</a>.</p>
<p>DataIn EDMA is NOT required, DataOut EDMA should be configured with format <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga87a51448bb00e451c837b590df405150">DPU_RangeProcHWA_EDMAOutputConfigFmt2</a>.<br />
 </p><table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Interleave </td></tr>
<tr>
<td align="left">HWA input mode</td><td align="center">Mapped </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_2 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">1, 2, 3 </td></tr>
</table>
<div class="image">
<img src="interleave_to_radarcubefmt2.png" alt="interleave_to_radarcubefmt2.png"/>
<div class="caption">
Interleaved data input to DPIF_RADARCUBE_FORMAT_2</div></div>
<p> Above picture illustrates a case of three transmit antennas, chirping within the frame with repeating pattern of (Tx1,Tx3,Tx2). This is the 3D profile (velocity and x,y,z) case. There are 4 rx antennas, the samples of which are color-coded and labeled as 1,2,3,4 with unique coloring for each of chirps that are processed in ping-pong manner to parallelize accelerator and EDMA processing with sample acquisition from ADC. The hardware accelerator's parameter RAMs are setup to do FFT which operates on the input ADC ping and pong buffers to produce output in M2 and M3 memories of the HWA. The processing needs to be given a kick every frame, this is done by the range DPU user by issuing the IOCTL command code <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#gga8c25dec4f8f383a3c745d8da510aad30a2018c7b6945733bb85135605f9de77d0">DPU_RangeProcHWA_Cmd_triggerProc</a> (this invokes <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga848a25b3b110dc988f34423505bf2a4f">rangeProcHWA_TriggerHWA</a>) which activates the HWA's dummy params PARAM_0 (ping) and PARAM_2 (pong) which in turn activate the processing PARAMs PARAM_1 (ping) and PARAM_3 (pong), these are waiting on the ADC full signal. When ADC has samples to process in the ADC buffer Ping or Pong memories, the corresponding processing PARAM will trigger FFT calculation and transfer the FFT output into the M2 or M3 memories. Before ADC samples are sent to FFT engine, the configured FFT window is applied to them in the HWA. The completion of FFT triggers the Data Out Ping/Pong EDMAs which have been setup to do a copy with transposition from the M2/M3 memories to the L3 RAM (Radar Cube) as shown in the picture. This HWA-EDMA ping-pong processing is done <a class="el" href="struct_d_p_u___range_proc_h_w_a___static_config__t.html#ad28ea5893f0001e2ef373f977dca0d39">DPU_RangeProcHWA_StaticConfig_t::numChirpsPerFrame</a>/2(ping/pong) times so that all chirps of the frame are processed. The EDMA is setup such that Data Out EDMAs are both chained to the Data Out Signature EDMA. So the Data Out Signature EDMA will trigger when the FFT result in M2/M3 memories is transferred to the radar cube. This signature EDMA is setup to trigger the dummy PARAMs. Even though the signature EDMA is a single EDMA channel, it is setup to alternate between the two dummy PARAMs so in effect when ping data out transfer is done, the ping dummy PARAM (PARAM_0) will be activated and when pong is done, the pong dummy PARAM (PARAM_2) will be activated. The signature EDMA is setup to give a completion interrupt after the last chirp which notifies software that range DPU processing is complete and user can trigger processing again for the next chirping period when the time comes. The shadow (link) PaRAMs of EDMA are used for reloading the PaRAMs so reprogramming is avoided. The blue arrows between EDMA blocks indicate linking and red arrows indicate chaining.</p>
<p>In further use cases, we do not describe the diagrams in such detail but the the general flow is similar. Details differ mostly in the programming of HWA and the amount of EDMA resources and their programming to handle the desired input and output formats.</p>
<h2>Non-Interleaved RX channel data -&gt; DPIF_RADARCUBE_FORMAT_2 </h2>
<p>This use case is for configuration with a directly mapped input buffer with non-interleaved ADC data. After Range FFT, data is saved in radar cube with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga52490164a754938e734d5b2fef66fe76">DPIF_RADARCUBE_FORMAT_2</a>.<br />
 A conversion of data from non-interleaved format to interleaved format is done by PARAM_1 AND PARAM_3.</p>
<p>DataIn EDMA is NOT required, DataOut EDMA should be configured with format <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga87a51448bb00e451c837b590df405150">DPU_RangeProcHWA_EDMAOutputConfigFmt2</a>.<br />
 </p><table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">HWA input mode</td><td align="center">Mapped </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_2 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">1, 2, 3 </td></tr>
</table>
<div class="image">
<img src="non-interleave_to_radarcubefmt2.png" alt="non-interleave_to_radarcubefmt2.png"/>
<div class="caption">
Non-interleaved data input to DPIF_RADARCUBE_FORMAT_2</div></div>
<h2>Non-Interleaved RX channel data(1 or 2 TX Antenna) -&gt; DPIF_RADARCUBE_FORMAT_1 </h2>
<p>This use case is for configuration with a directly mapped input buffer with non-interleaved ADC data. After RangeFFT, data is saved in radar cube with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>.</p>
<p>DataIn EDMA is NOT required, DataOut EDMA should be configured with format <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga87a51448bb00e451c837b590df405150">DPU_RangeProcHWA_EDMAOutputConfigFmt2</a>.<br />
 The diagram shows radarCube in 2 TX Antenna format. The output of Ping will be saved in TX1 section and output of Pong will be saved in TX2 section of the radar cube. For one TX antenna case, data from ping and pong data will be saved in TX1 radar cube in alternate order.</p>
<table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">HWA input mode</td><td align="center">Mapped </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">1, 2 </td></tr>
</table>
<div class="image">
<img src="non-interleave_to_radarcubefmt1.png" alt="non-interleave_to_radarcubefmt1.png"/>
<div class="caption">
Non-interleaved data input to DPIF_RADARCUBE_FORMAT_1</div></div>
<h2>Isolated Non-Interleaved RX channel data(1 or 2 TX Antenna) -&gt; DPIF_RADARCUBE_FORMAT_1 </h2>
<p>This use case is for configuration with isolated input buffer with non-interleaved ADC data. After RangeFFT, data is saved in radar cube with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>. <br />
 DataIn EDMA is required, DataOut EDMA should be configured with format <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga87a51448bb00e451c837b590df405150">DPU_RangeProcHWA_EDMAOutputConfigFmt2</a> <br />
 The diagram shows radarCube in 2 TX Antenna format. The output of Ping will be saved in TX1 section and output of Pong will be saved in TX2 section of the radar cube. For one TX antenna case, data from ping and pong will be saved in TX1 radar cube in alternate order.</p>
<table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">HWA input mode</td><td align="center">Isolated </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">1, 2 </td></tr>
</table>
<div class="image">
<img src="isolated_non-interleave_to_radarcubefmt1.png" alt="isolated_non-interleave_to_radarcubefmt1.png"/>
<div class="caption">
Isolated Non-interleaved data input to DPIF_RADARCUBE_FORMAT_1</div></div>
<h2>Isolated Non-Interleaved RX channel data(3 TX Antenna) -&gt; DPIF_RADARCUBE_FORMAT_1 </h2>
<p>This use case is for configuration with isolated input buffer with non-interleaved ADC data. After RangeFFT, data is saved in radar cube with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>.<br />
 DataIn EDMA is required, DataOut EDMA should be configured with format <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga1e16e56295f0c691c990546c43ee5dd9">DPU_RangeProcHWA_EDMAOutputConfigFmt1</a>.<br />
 The output of Ping/Pong FFT results will be saved in radar cube as follows: Ping 1 (first dataOut EDMA channel) data will goto odd number doppler chirps in TX1, as shown in dark grey arrow) Ping 2 (second dataOut EDMA channel) data will goto odd number doppler chirps in TX3, as shown in light blue arrow) Ping 3 (third dataOut EDMA channel) data will goto even number doppler chirps in TX2, as shown in peach arrow)</p>
<p>Pong 1 (first dataOut EDMA channel) data will goto odd number doppler chirps in TX2, as shown in dark green arrow) Pong 2 (second dataOut EDMA channel) data will goto even number doppler chirps in TX1, as shown in light green arrow) Pong 3 (third dataOut EDMA channel) data will goto even number doppler chirps in TX3, as shown in blue arrow)</p>
<table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">HWA input mode</td><td align="center">Isolated </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">3 </td></tr>
</table>
<div class="image">
<img src="isolated_non-interleave_to_radarcubefmt1_3tx.png" alt="isolated_non-interleave_to_radarcubefmt1_3tx.png"/>
<div class="caption">
3 TX Isolated Non-interleaved data input to DPIF_RADARCUBE_FORMAT_1</div></div>
<h1><a class="anchor" id="dpu2"></a>
RangeProcDSP</h1>
<h2><a class="anchor" id="toplevel_dsp"></a>
Top Level Design</h2>
<p>RangeProcDSP has 3 stages in its processing:</p><ul>
<li>Bring in ADC data through dataIn EDMA channels</li>
<li>FFT processing using DSPlib/mmwavelib</li>
<li>Transfer FFT results to radar cube through dataOut EDMA channels</li>
</ul>
<p>The following diagram shows the top level design for rangeProcDSP.<br />
 </p><div class="image">
<img src="rangeprocdsp_toplevel.png" alt="rangeprocdsp_toplevel.png"/>
<div class="caption">
rangeProcDSP Top Level</div></div>
<h2><a class="anchor" id="config_dsp"></a>
Data Interface Parameter Range</h2>
<p>Here are the supported ADCBuf and radarCube interface configurations:</p>
<h2>ADCBuf Data Interface </h2>
<table class="doxtable">
<tr>
<th align="left">Parameter </th><th align="center">Supported value  </th></tr>
<tr>
<td align="left">dataFmt </td><td align="center">DPIF_DATAFORMAT_COMPLEX16_IMRE ONLY </td></tr>
<tr>
<td align="left">interleave</td><td align="center">non-interleave ONLY </td></tr>
<tr>
<td align="left">numChirpsPerChirpEvent</td><td align="center">As ADCBuf memory permit </td></tr>
<tr>
<td align="left">numRxAntennas</td><td align="center">1, 2, 4 </td></tr>
<tr>
<td align="left">numAdcSamples</td><td align="center">64 - 2048 (even number only) </td></tr>
</table>
<h2>Radar Cube Data Interface </h2>
<table class="doxtable">
<tr>
<th align="left">Parameter </th><th align="center">Supported value  </th></tr>
<tr>
<td align="left">dataFmt </td><td align="center">DPIF_DATAFORMAT_COMPLEX16_IMRE ONLY </td></tr>
<tr>
<td align="left">layoutFmt </td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAntennas</td><td align="center">1, 2 and 3 </td></tr>
<tr>
<td align="left">numRangeBins</td><td align="center">64 - 2048 </td></tr>
<tr>
<td align="left">numChirpsPerFrame</td><td align="center">As ADCBuf and HWA memory permit </td></tr>
</table>
<h2><a class="anchor" id="input_dsp"></a>
Data Input</h2>
<p>RangeProcDSP DPU transfers ADCBuf data through dataIn EDMA channels in ping/pong alternate order to FFT input scratch buffer - adcDataIn.</p>
<h2><a class="anchor" id="output_dsp"></a>
Data Output</h2>
<p>RangeProcDSP DPU transfer FFT results in scratch buffer(fftOut1D) to radarCube through dataOut EDMA channels in ping/pong alternate order.</p>
<h2><a class="anchor" id="process_dsp"></a>
Data Processing</h2>
<p>Range FFT processing is done by using DSPlib and mmwavelib APIs. FFT input data is stored in input scratch buffer - adcDataIn, its output data is stored in output scratch buffer - fftOut1D.</p>
<p>As shown in the following diagram, for every chirp event <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#gad855fe206de3214567c64e2a20a17141">DPU_RangeProcDSP_process</a> is called to process the data in ADCBuf buffer. If the hardware resources or data interfaces are changed for next frame, <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga325ba2a721182c2a2c968fd73d6f7b5c">DPU_RangeProcDSP_config</a> can be called before the next frame starts.</p>
<p>DC signal removal configuration can be updated at inter-frame time before the next frame starts.</p>
<div class="image">
<img src="dsp_callflow.png" alt="dsp_callflow.png"/>
<div class="caption">
rangeProcDSP call flow</div></div>
<h3><a class="anchor" id="calibDC_Range_dsp"></a>
Antenna coupling signature removal</h3>
<p>This feature is controlled through configuration <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ga95abfbaedd9cb13f4a02e770f3ab0e08">DPU_RangeProc_CalibDcRangeSigCfg</a>. The configuration can be sent to rangeProc DPU through API <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga325ba2a721182c2a2c968fd73d6f7b5c">DPU_RangeProcDSP_config</a>. <br />
 The configuration can also be updated at runtime through control command <a class="el" href="group___d_p_u___r_a_n_g_e_p_r_o_c___e_x_t_e_r_n_a_l___d_a_t_a___s_t_r_u_c_t_u_r_e.html#ggaabd17f12617f8e65adc87dbc5056d37aa1ae008f0759c6ef17313799cf8f5ab66">DPU_RangeProcDSP_Cmd_dcRangeCfg</a>.</p>
<p>DC signal calibration and compensation is operated on fftOut1D data buffer for every chirp event.</p>
<div class="image">
<img src="dsp_dcremoval.png" alt="dsp_dcremoval.png"/>
<div class="caption">
rangeProcDSP Antenna DC signal removal</div></div>
<h2><a class="anchor" id="details_dsp"></a>
Use Cases</h2>
<p>This Section describes some of the internal implementation for a few use cases for different number of TX antenna.</p>
<p>Regardless of number of TX antennas, 2 input EDMA channels and 2 output EDMA channels are needed for range FFT to work in ping/pong manner. Ping input channel brings data into Ping region of local memory "adcDataIn", pong channel brings data into pong region.</p>
<p>After FFT, for 2 TX antenna, ping results in local memory "fftout1D" are copied to TX1 region in radar cube. Pong results are copied to TX2 region in radar cube.<br />
 For 3 TX antenna, ping always handles the odd chirp data, pong always handle even chirp data. Range FFT results are copied to radar cube in following format:<br />
</p><pre class="fragment">    TX1 region holds data for chirp index = 3 * (dopplerChirpIdx - 1) +1
    TX2 region holds data for chirp index = 3 * (dopplerChirpIdx - 1) +2
    TX3 region holds data for chirp index = 3 * dopplerChirpIdx

    chirp index is in range [1,numChirpsPerFrame]
    dopplerChirpIdx is in range [1, numDopplerChirps = numChirpsPerFrame/numTxAntennas]
</pre><h2>Non-Interleaved RX channel data(1 or 2 TX Antenna) -&gt; DPIF_RADARCUBE_FORMAT_1 </h2>
<p>This use case is for configuration with with 1 or 2 TX antenna(diagram shows 2 TX antenna) with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>.</p>
<table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">1, 2 </td></tr>
</table>
<div class="image">
<img src="dsp_2tx.png" alt="dsp_2tx.png"/>
<div class="caption">
2 TX Non-interleaved data input to DPIF_RADARCUBE_FORMAT_1</div></div>
<h2>Non-Interleaved RX channel data(3 TX Antenna) -&gt; DPIF_RADARCUBE_FORMAT_1 </h2>
<p>This use case is for configuration with with 3 TX antenna with format:<a class="el" href="group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>.</p>
<table class="doxtable">
<tr>
<th align="left">Input params </th><th align="center">Setting  </th></tr>
<tr>
<td align="left">InterleaveMode </td><td align="center">Non-Interleave </td></tr>
<tr>
<td align="left">RadarCube format</td><td align="center">DPIF_RADARCUBE_FORMAT_1 </td></tr>
<tr>
<td align="left">numTxAnt</td><td align="center">3 </td></tr>
</table>
<div class="image">
<img src="dsp_3tx.png" alt="dsp_3tx.png"/>
<div class="caption">
3TX Non-interleaved data input to DPIF_RADARCUBE_FORMAT_1</div></div>
</div></div><!-- contents -->
<hr size="1"><small>
Copyright  2018, Texas Instruments Incorporated</small>
</body>
</html>
